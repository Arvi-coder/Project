CREATE PROCEDURE PRREMARKSTRAILSEARCH
(
    @ROWUSERCODE            INT,
    @EMPLOYEEFIRSTNAME      VARCHAR(50) = NULL,
    @EMPLOYEELASTNAME       VARCHAR(50) = NULL,
    @EMPLOYEEAGE            INT = NULL,
    @EMPLOYEECITY           VARCHAR(40) = NULL,
    @SORTBY                 VARCHAR(100) = NULL,
    @SORTDIRECTION          TINYINT = NULL,
    @PAGENUMBER             INT,
    @PAGESIZE               INT,
    @RESULTCOUNT            INT OUTPUT,
    @TOTALPAGECOUNT         INT OUTPUT
)
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @ROWFROM BIGINT
    DECLARE @ROWTO BIGINT

    DECLARE @TEMPTABLE TABLE
    (
        FLDREMARKSTRAILID   UNIQUEIDENTIFIER,
        FLDROWNUMBER        BIGINT IDENTITY(1,1)
    )

    SET @EMPLOYEEFIRSTNAME = ISNULL(@EMPLOYEEFIRSTNAME, '') + '%'
    SET @EMPLOYEELASTNAME = ISNULL(@EMPLOYEELASTNAME, '') + '%'
    SET @EMPLOYEECITY = ISNULL(@EMPLOYEECITY, '') + '%'
    SET @SORTDIRECTION = ISNULL(@SORTDIRECTION, 0)

    IF @SORTDIRECTION = 0
    BEGIN
        INSERT INTO @TEMPTABLE (FLDREMARKSTRAILID)
        SELECT RT.FLDREMARKSTRAILID
        FROM TBLREMARKSTRAIL RT(NOLOCK)
        WHERE 
            (RT.FLDEMPLOYEEFIRSTNAME LIKE @EMPLOYEEFIRSTNAME)
            AND (RT.FLDEMPLOYEELASTNAME LIKE @EMPLOYEELASTNAME)
            AND (RT.FLDEMPLOYEEAGE = @EMPLOYEEAGE OR @EMPLOYEEAGE IS NULL)
            AND (RT.FLDEMPLOYEECITY LIKE @EMPLOYEECITY)
        ORDER BY 
            CASE WHEN @SORTBY = 'FLDEMPLOYEEFIRSTNAME' THEN RT.FLDEMPLOYEEFIRSTNAME
                 WHEN @SORTBY = 'FLDEMPLOYEELASTNAME' THEN RT.FLDEMPLOYEELASTNAME
                 ELSE RT.FLDREMARKSTRAILID END

        SET @RESULTCOUNT = @@ROWCOUNT
        SET @TOTALPAGECOUNT = DBO.FNTOTALPAGECOUNT(@RESULTCOUNT, @PAGESIZE)
        SET @ROWFROM = DBO.FNROWFROM(@PAGENUMBER, @PAGESIZE)
        SET @ROWTO = DBO.FNROWTO(@PAGENUMBER, @PAGESIZE)
    END

    IF @SORTDIRECTION = 1
    BEGIN
        INSERT INTO @TEMPTABLE (FLDREMARKSTRAILID)
        SELECT RT.FLDREMARKSTRAILID
        FROM TBLREMARKSTRAIL RT(NOLOCK)
        WHERE 
            (RT.FLDEMPLOYEEFIRSTNAME LIKE @EMPLOYEEFIRSTNAME)
            AND (RT.FLDEMPLOYEELASTNAME LIKE @EMPLOYEELASTNAME)
            AND (RT.FLDEMPLOYEEAGE = @EMPLOYEEAGE OR @EMPLOYEEAGE IS NULL)
            AND (RT.FLDEMPLOYEECITY LIKE @EMPLOYEECITY)
        ORDER BY 
            CASE WHEN @SORTBY = 'FLDEMPLOYEEFIRSTNAME' THEN RT.FLDEMPLOYEEFIRSTNAME
                 WHEN @SORTBY = 'FLDEMPLOYEELASTNAME' THEN RT.FLDEMPLOYEELASTNAME
                 ELSE RT.FLDREMARKSTRAILID END DESC

        SET @RESULTCOUNT = @@ROWCOUNT
        SET @TOTALPAGECOUNT = DBO.FNTOTALPAGECOUNT(@RESULTCOUNT, @PAGESIZE)
        SET @ROWFROM = DBO.FNROWFROM(@PAGENUMBER, @PAGESIZE)
        SET @ROWTO = DBO.FNROWTO(@PAGENUMBER, @PAGESIZE)
    END

    SELECT 
        RT.FLDREMARKSTRAILID,
        RT.FLDEMPLOYEEFIRSTNAME,
        RT.FLDEMPLOYEELASTNAME,
        RT.FLDEMPLOYEEAGE,
        RT.FLDEMPLOYEECITY,
        RT.FLDCREATEDDATE,
        RT.FLDCREATEDBY,
        RT.FLDMODIFIEDDATE,
        RT.FLDMODIFIEDBY,
        RT.FLDDTKEY
    FROM @TEMPTABLE T
    INNER JOIN TBLREMARKSTRAIL RT (NOLOCK)
        ON RT.FLDREMARKSTRAILID = T.FLDREMARKSTRAILID
    WHERE T.FLDROWNUMBER BETWEEN @ROWFROM AND @ROWTO
    ORDER BY T.FLDROWNUMBER

END
