
CREATE PROCEDURE PROFFSHORECHARTERINGINVOICERECEIVABLESEARCH      
(          
   
  ,@VESSELLIST			NVARCHAR(50)		= NULL      
  ,@SORTBY				VARCHAR(100)		= NULL          
  ,@SORTDIRECTION		TINYINT				= NULL            
  ,@PAGENUMBER			INT           
  ,@PAGESIZE			INT            
  ,@RESULTCOUNT			INT  OUTPUT          
  ,@TOTALPAGECOUNT		INT  OUTPUT            
)      
AS      
BEGIN      
	SET NOCOUNT ON;             
	DECLARE @ROWFROM BIGINT            
	DECLARE @ROWTO   BIGINT          
	DECLARE @TEMPTABLE TABLE (FLDINVOICECODE UNIQUEIDENTIFIER, FLDROWNUMBER BIGINT IDENTITY (1,1))          
		
	SET @SORTDIRECTION = ISNULL(@SORTDIRECTION, 0)   		
	
	INSERT INTO @TEMPTABLE (FLDINVOICECODE)                    
	SELECT FLDINVOICECODE       
	FROM TBLINVOICERECEIVABLE R (NOLOCK)      
		INNER JOIN TBLOFFSHORECHARTERINGBILLINGINFO BI (NOLOCK)      
			ON R.FLDBILLINGCONTRACTID = BI.FLDOFFSHORECHARTERINGBILLINGINFOID      
		INNER JOIN TBLVESSEL V(NOLOCK)
			ON CONVERT(INT,R.FLDVESSELLIST) = V.FLDVESSELID
		WHERE   (R.FLDINVOICENUMBER LIKE '%' +@INVOICENUMBER + '%' OR @INVOICENUMBER IS NULL)
				AND (R.FLDOWNERCODE			= @OWNERCODE      OR @OWNERCODE IS NULL)     
				AND (R.FLDSTATUS			= @STATUS         OR @STATUS IS NULL) 
				AND (R.FLDCURRENCYID		= @CURRENCYCODE   OR @CURRENCYCODE IS NULL) 
				AND (R.FLDINVOICEDATE     > @INVOICEFROMDATE  OR @INVOICEFROMDATE IS NULL)
				AND (R.FLDINVOICEDATE     < @INVOICETODATE    OR @INVOICETODATE IS NULL)
				AND (V.FLDVESSELNAME LIKE '%' +@VESSELLIST + '%' OR @VESSELLIST IS NULL)
				AND (R.FLDRECEIVEDSTATUS = @RECEIVEDSTATUS     OR @RECEIVEDSTATUS IS NULL)    
				AND (R.FLDRECEIVEDDATE     > @RECEIVEDFROMDATE OR @RECEIVEDFROMDATE IS NULL)
				AND (R.FLDRECEIVEDDATE     < @RECEIVEDTODATE   OR @RECEIVEDTODATE IS NULL)
				AND (R.FLDTYPE			= @TYPE         OR @TYPE IS NULL) 
				AND (R.FLDBILLINGCOMPANYID	= @BILLINGCOMPANYID OR @BILLINGCOMPANYID IS NULL) 
	ORDER BY       FLDINVOICEDATE DESC
		
		SET @RESULTCOUNT    = @@ROWCOUNT            
		SET @TOTALPAGECOUNT = DBO.FNTOTALPAGECOUNT(@RESULTCOUNT,@PAGESIZE)            
		SET @ROWFROM        = DBO.FNROWFROM(@PAGENUMBER,@PAGESIZE)            
		SET @ROWTO          = DBO.FNROWTO(@PAGENUMBER,@PAGESIZE)                
	              
	    
	  SELECT  T.FLDINVOICECODE      
		,R.FLDINVOICESERIALNUMBER      
		,R.FLDINVOICENUMBER      
		,R.FLDINVOICEDATE      
		,R.FLDTYPE      
		,B.FLDNAME AS FLDTYPENAME      
		,B.FLDSHORDCODE      
		,B.FLDBILLINGITEMID      
		,R.FLDOWNERCODE      
		,A.FLDNAME      
		,R.FLDBANKACCOUNTID      
		,BA.FLDBANKNAME      
		,BA.FLDACCOUNTNUMBER  
		,R.FLDCURRENCYID      
		,C.FLDCURRENCYCODE      
		,R.FLDAMOUNT      
		,R.FLDBILLINGCOMPANYID      
		,R.FLDRECEIVEDAMOUNT      
		,(R.FLDAMOUNT - R.FLDRECEIVEDAMOUNT) AS FLDDIFFERENCE      
		,R.FLDRECEIVEDDATE      
		,R.FLDRECEIVEDSTATUS      
		,HH.FLDHARDNAME AS FLDRECEIVEDSTATUSNAME      
		,R.FLDBILLINGCONTRACTID      
		,BI.FLDBILLINGINFONUMBER AS FLDREFERENCENUMBER      
		,CC.FLDCOMPANYNAME      
		,R.FLDSTATUS      
		,H.FLDHARDNAME      
		,R.FLDVESSELLIST      
		,V.FLDVESSELNAME      
		,R.FLDACTIVEYN      
		,R.FLDREMARKS      
		,R.FLDCREATEDDATE      
		,R.FLDCREATEDBY      
		,R.FLDMODIFIEDDATE      
		,R.FLDMODIFIEDBY      
		,R.FLDDTKEY      
		,B.FLDREVISIONID      
		,B.FLDREVISIONNO      
	  FROM @TEMPTABLE T      
	   LEFT JOIN TBLINVOICERECEIVABLE R (NOLOCK)      
		ON T.FLDINVOICECODE = R.FLDINVOICECODE      
	   LEFT JOIN TBLCURRENCY C(NOLOCK)      
		 ON  C.FLDCURRENCYID = R.FLDCURRENCYID         
	   LEFT JOIN TBLSYNADDRESS A(NOLOCK)      
		ON A.FLDADDRESSCODE = R.FLDOWNERCODE      
	   LEFT JOIN TBLSYNCOMPANY CC (NOLOCK)      
		ON CC.FLDCOMPANYID = R.FLDBILLINGCOMPANYID      
	   LEFT JOIN TBLHARD H (NOLOCK)      
		ON R.FLDSTATUS = H.FLDHARDCODE      
		AND H.FLDHARDTYPECODE = 6       
	   LEFT JOIN TBLHARD HH (NOLOCK)      
		ON R.FLDRECEIVEDSTATUS = HH.FLDHARDCODE      
		AND HH.FLDHARDTYPECODE = 7      
	   LEFT JOIN TBLVESSEL V (NOLOCK)     
		ON V.FLDVESSELID = R.FLDVESSELLIST      
	   LEFT JOIN TBLOFFSHORECHARTERINGBILLINGINFO BI (NOLOCK)      
		ON R.FLDBILLINGCONTRACTID = FLDOFFSHORECHARTERINGBILLINGINFOID      
	   LEFT JOIN TBLBILLINGITEM B (NOLOCK)      
		ON B.FLDBILLINGITEMID = R.FLDTYPE      
	   LEFT JOIN TBLSYNBANKINFORMATIONADDRESS BA (NOLOCK)      
		ON BA.FLDBANKID = R.FLDBANKACCOUNTID      
	  WHERE T.FLDROWNUMBER BETWEEN @ROWFROM AND @ROWTO      
	  ORDER BY T.FLDROWNUMBER
  
END      
